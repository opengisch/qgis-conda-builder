---
name: ðŸŽ MacOS
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
      
# TODO: probably create a nightly job

jobs:
  package:
    runs-on: macos-13
    strategy:
      matrix:
        include:
          - architecture: 'x86_64'
            conda_platform: 'osx-64'
          - architecture: 'arm64'
            conda_platform: 'osx-arm64'

    name: Package for macOS
    steps:
      - name: ðŸ£ Checkout
        uses: actions/checkout@v3

      - name: ðŸ£ Checkout Constructor
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          repository: opengisch/constructor
          ref: qgis-bundling
          path: constructor

      - uses: conda-incubator/setup-miniconda@v2
        with:
          miniconda-version: "latest"
          activate-environment: "constructor"
          environment-file: "environment.yaml"

      - name: ðŸŒ¾ Get latest version
        shell: bash
        run: |
          QGIS_VERSION=$(conda search -c conda-forge -f qgis | grep py311 | tail -n 1 | tr -s ' ' | cut -f 2 -d ' ')
          QGIS_VERSION_SHORT=$(echo $QGIS_VERSION | cut -d'.'  -f 1,2)
          echo QGIS_VERSION=$QGIS_VERSION >> $GITHUB_ENV
          echo QGIS_VERSION_SHORT=$QGIS_VERSION_SHORT >> $GITHUB_ENV
          echo MICROMAMBA_PLATFORM=$MICROMAMBA_PLATFORM >> $GITHUB_ENV

          sed -i '' "s/__ver__/$QGIS_VERSION/g" construct.yaml
          sed -i '' "s/__shortver__/$QGIS_VERSION_SHORT/g" construct.yaml

      - name: ðŸ“¦ Package
        shell: pwsh
        run: |
          curl -s https://api.github.com/repos/mamba-org/micromamba-releases/releases/latest
          curl -s https://api.github.com/repos/mamba-org/micromamba-releases/releases/latest | grep 'browser_download_url.*micromamba-${{ env.MICROMAMBA_PLATFORM }}"' | cut -d : -f 2,3 | tr -d '"'
          curl -s https://api.github.com/repos/mamba-org/micromamba-releases/releases/latest | grep 'browser_download_url.*micromamba-${{ env.MICROMAMBA_PLATFORM }}"' | cut -d : -f 2,3 | tr -d '"' | wget -qi -
          wget https://github.com/mamba-org/micromamba-releases/releases/download/1.4.9-0/micromamba-${{ env.MICROMAMBA_PLATFORM }}
          ls -al
          conda build constructor
          conda install /Users/runner/miniconda3/envs/constructor/conda-bld/osx-64/*.tar.bz2
          constructor --platform=${{ env.MICROMAMBA_PLATFORM }} --conda-exe=micromamba-${{ env.MICROMAMBA_PLATFORM }} .

      - name: ðŸ“¦ Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: QGIS-${{ env.QGIS_VERSION }}-MacOSX-${{ matrix.architecture }}
          path: QGIS-${{ env.QGIS_VERSION }}-MacOSX-${{ matrix.architecture }}.pkg

